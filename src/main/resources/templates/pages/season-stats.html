<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title th:text="${season.year} + ' Season Analytics'">Season Analytics</title>
</head>
<body>
<main layout:fragment="content">

    <div class="page-header">
        <h1 class="page-title" th:text="${season.year} + ' Season — League Analytics'">2026 Season — League Analytics</h1>
        <div class="page-header__actions">
            <select class="form-input form-input--sm"
                    onchange="window.location='/seasons/'+this.value+'/stats'">
                <option th:each="s : ${allSeasons}"
                        th:value="${s.year}"
                        th:text="${s.year}"
                        th:selected="${s.year == season.year}">2026</option>
            </select>
        </div>
    </div>

    <!-- Date picker -->
    <div class="analytics-date-row" th:if="${latestDate != null}">
        <label class="form-label" for="stat-date">Snapshot date:</label>
        <input type="date" id="stat-date" class="form-input form-input--sm"
               th:value="${selectedDate}"
               th:min="${season.startDate}"
               th:max="${latestDate}"
               hx-get="@{'/seasons/' + ${season.year} + '/stats/table'}"
               hx-target="#stats-table-container"
               hx-trigger="change"
               name="date" />
        <span class="text-muted" th:text="'Latest data: ' + ${latestDate}">Latest data: 2026-02-26</span>
    </div>

    <!-- Charts row -->
    <div class="analytics-charts" th:if="${hasData}">
        <div class="analytics-chart-card">
            <h3 class="analytics-chart-card__title">Win % Distribution</h3>
            <div class="analytics-chart-wrap">
                <canvas id="chart-win-pct-dist"></canvas>
            </div>
        </div>
        <div class="analytics-chart-card">
            <h3 class="analytics-chart-card__title">Avg Pts Scored vs Allowed</h3>
            <div class="analytics-chart-wrap">
                <canvas id="chart-pts-scatter"></canvas>
            </div>
        </div>
    </div>

    <!-- Stats table (HTMX-swappable) -->
    <div id="stats-table-container">
        <div th:replace="~{fragments/season-stats-table :: stats-table}"></div>
    </div>

    <div th:if="${latestDate == null}" class="teams-empty">
        No time-series data found for this season. Use the admin panel to run a <strong>Time Series</strong> calculation.
    </div>

</main>

<th:block layout:fragment="scripts">
<script th:inline="javascript">
(function () {
    const snapshots = /*[[${snapshots}]]*/ [];

    if (!snapshots || snapshots.length === 0) return;

    // Win % histogram (bucket into 10% bins)
    const bins = Array(11).fill(0);
    snapshots.forEach(s => {
        if (s.winPct != null) {
            const idx = Math.min(Math.floor(s.winPct * 10), 10);
            bins[idx]++;
        }
    });
    const binLabels = ['0-10%','10-20%','20-30%','30-40%','40-50%',
                       '50-60%','60-70%','70-80%','80-90%','90-100%','100%'];

    new Chart(document.getElementById('chart-win-pct-dist'), {
        type: 'bar',
        data: {
            labels: binLabels,
            datasets: [{
                label: 'Teams',
                data: bins,
                backgroundColor: 'rgba(59,130,246,0.6)',
                borderColor: '#3b82f6',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });

    // Pts scored vs allowed scatter
    const scatterData = snapshots
        .filter(s => s.meanPtsFor != null && s.meanPtsAgainst != null)
        .map(s => ({ x: +s.meanPtsFor.toFixed(1), y: +s.meanPtsAgainst.toFixed(1), label: s.teamName }));

    new Chart(document.getElementById('chart-pts-scatter'), {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Teams',
                data: scatterData,
                backgroundColor: 'rgba(34,197,94,0.6)',
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            const p = ctx.raw;
                            return (p.label || '') + ': ' + p.x + ' scored, ' + p.y + ' allowed';
                        }
                    }
                }
            },
            scales: {
                x: { title: { display: true, text: 'Avg Points Scored' } },
                y: { title: { display: true, text: 'Avg Points Allowed' } }
            }
        }
    });
})();
</script>
</th:block>
</body>
</html>
