<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title th:text="${season.year} + ' Season Analytics'">Season Analytics</title>
</head>
<body>
<main layout:fragment="content">

    <div class="page-header">
        <h1 class="page-title" th:text="${season.year} + ' Season — League Analytics'">2026 Season — League Analytics</h1>
        <div class="page-header__actions">
            <select class="form-input form-input--sm"
                    onchange="window.location='/seasons/'+this.value+'/stats'">
                <option th:each="s : ${allSeasons}"
                        th:value="${s.year}"
                        th:text="${s.year}"
                        th:selected="${s.year == season.year}">2026</option>
            </select>
        </div>
    </div>

    <!-- Date picker -->
    <div class="analytics-date-row" th:if="${latestDate != null}">
        <label class="form-label" for="stat-date">Snapshot date:</label>
        <input type="date" id="stat-date" class="form-input form-input--sm"
               th:value="${selectedDate}"
               th:min="${season.startDate}"
               th:max="${latestDate}"
               hx-get="@{'/seasons/' + ${season.year} + '/stats/table'}"
               hx-target="#stats-table-container"
               hx-trigger="change"
               name="date" />
        <span class="text-muted" th:text="'Latest data: ' + ${latestDate}">Latest data: 2026-02-26</span>
    </div>

    <!-- Charts row -->
    <div class="analytics-charts" th:if="${hasData}"
         th:data-year="${season.year}"
         th:data-date="${selectedDate}"
         id="season-charts">
        <div class="analytics-chart-card">
            <h3 class="analytics-chart-card__title">Avg Margin Distribution</h3>
            <div class="analytics-chart-wrap">
                <canvas id="chart-win-pct-dist"></canvas>
            </div>
        </div>
        <div class="analytics-chart-card">
            <h3 class="analytics-chart-card__title">Avg Pts Scored vs Allowed</h3>
            <div class="analytics-chart-wrap">
                <canvas id="chart-pts-scatter"></canvas>
            </div>
        </div>
    </div>

    <!-- Stats table (HTMX-swappable) -->
    <div id="stats-table-container">
        <div th:replace="~{fragments/season-stats-table :: stats-table}"></div>
    </div>

    <div th:if="${latestDate == null}" class="teams-empty">
        No time-series data found for this season. Use the admin panel to run a <strong>Time Series</strong> calculation.
    </div>

</main>

<th:block layout:fragment="scripts">
<script>
(function () {
    const container = document.getElementById('season-charts');
    if (!container) return;

    const year = container.dataset.year;
    const date = container.dataset.date;
    if (!year || !date) return;

    fetch('/api/statistics/season/' + year + '/snapshots?date=' + date)
        .then(r => r.ok ? r.json() : [])
        .then(renderCharts)
        .catch(() => {});

    function renderCharts(snapshots) {
        if (!snapshots || snapshots.length === 0) return;

        // Avg margin histogram — 5-point bins centred on multiples of 5
        const margins = snapshots.map(s => s.meanMargin).filter(v => v != null);
        const binSize = 2.5;
        const minBin = Math.floor(Math.min(...margins) / binSize) * binSize;
        const maxBin = Math.ceil(Math.max(...margins) / binSize) * binSize;
        const binCount = (maxBin - minBin) / binSize + 1;
        const bins = Array(binCount).fill(0);
        margins.forEach(m => {
            const idx = Math.floor((m - minBin) / binSize);
            bins[Math.min(idx, binCount - 1)]++;
        });
        const binLabels = Array.from({ length: binCount }, (_, i) => {
            const lo = minBin + i * binSize;
            const s = Number.isInteger(lo) ? lo.toString() : lo.toFixed(1);
            return (lo >= 0 ? '+' : '') + s;
        });

        new Chart(document.getElementById('chart-win-pct-dist'), {
            type: 'bar',
            data: {
                labels: binLabels,
                datasets: [{
                    label: 'Teams',
                    data: bins,
                    backgroundColor: bins.map((_, i) => (minBin + i * binSize) >= 0
                        ? 'rgba(34,197,94,0.6)' : 'rgba(239,68,68,0.6)'),
                    borderColor: bins.map((_, i) => (minBin + i * binSize) >= 0
                        ? '#22c55e' : '#ef4444'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                aspectRatio: 1,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });

        // Pts scored vs allowed scatter — shared axis scale so both dimensions are comparable
        const scatterData = snapshots
            .filter(s => s.meanPtsFor != null && s.meanPtsAgainst != null)
            .map(s => ({ x: +s.meanPtsFor.toFixed(1), y: +s.meanPtsAgainst.toFixed(1), label: s.teamName }));

        const allPts = scatterData.flatMap(p => [p.x, p.y]);
        const padding = 2;
        const axisMin = Math.floor(Math.min(...allPts)) - padding;
        const axisMax = Math.ceil(Math.max(...allPts)) + padding;
        const axisOpts = { min: axisMin, max: axisMax };

        new Chart(document.getElementById('chart-pts-scatter'), {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: 'Teams',
                        data: scatterData,
                        backgroundColor: 'rgba(59,130,246,0.6)',
                        pointRadius: 5
                    },
                    {
                        label: 'Scored = Allowed',
                        type: 'line',
                        data: [{ x: axisMin, y: axisMin }, { x: axisMax, y: axisMax }],
                        borderColor: 'rgba(255,255,255,0.3)',
                        borderWidth: 1,
                        borderDash: [6, 4],
                        pointRadius: 0,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                aspectRatio: 1,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const p = ctx.raw;
                                return (p.label || '') + ': ' + p.x + ' scored, ' + p.y + ' allowed';
                            }
                        }
                    }
                },
                scales: {
                    x: { ...axisOpts, title: { display: true, text: 'Avg Points Scored' } },
                    y: { ...axisOpts, title: { display: true, text: 'Avg Points Allowed' } }
                }
            }
        });
    }
})();
</script>
</th:block>
</body>
</html>
